---
title: "2022-02-14_星期一"
date: 2022-02-14T19:20:14+08:00
draft: false
tags: ['执行计划', '消息', '数据库', '提交', 'SQL', '消费', '存储', '参数', '连接器', '主键索引']
---

## 消息队列高手课

一条消息从生产到消费完成这个过程，可以划分三个阶段：
![20220214130936.png](20220214130936.png)

- **生产阶段**: 在这个阶段，从消息在 Producer 创建出来，经过网络传输发送到 Broker 端。
- **存储阶段**: 在这个阶段，消息在 Broker 端存储，如果是集群，消息会在这个阶段被复制到其他的副本上。
- **消费阶段**: 在这个阶段，Consumer 从 Broker 上拉取消息，经过网络传输发送到 Consumer 上。

每个阶段都需要正确的编写代码并且设置正确的配置项，才能配合消息队列的可靠性机制，确保消息不会丢失：

- 在生产阶段，你需要捕获消息发送的错误，并**重发消息**。
- 在存储阶段，你可以通过配置**刷盘和复制相关的参数**，让消息写入到**多个副本**的磁盘上，来确保消息不会因为某个 Broker 宕机或者磁盘损坏而丢失。
- 在消费阶段，你需要在**处理完全部消费业务逻辑之后，再发送消费确认**。

## 后端技术面试 38 讲

我们在 Java 程序中访问数据库的时候，有两种提交 SQL 语句的方式，一种是通过 Statement 直接提交 SQL；另一种是先通过 PrepareStatement 预编译 SQL，然后设置可变参数再提交执行。

### SQL 执行过程

  1. 一个 SQL 提交到数据库，经过连接器将 SQL 语句交给语法分析器，生成一个抽象语法树 AST；
  2. AST 经过语义分析与优化器，进行语义优化，使计算过程和需要获取的中间数据尽可能少，然后得到数据库执行计划；
  3. 执行计划提交给具体的执行引擎进行计算，将结果通过连接器再返回给应用程序

![20220214131801.png](20220214131801.png)

### 使用 PrepareStatement 执行 SQL 的好处

1. PrepareStatement 会预先提交带占位符的 SQL 到数据库进行预处理，提前生成执行计划，当给定占位符参数，真正执行 SQL 的时候，执行引擎可以直接执行，**效率更好**一点
2. （更重要）PrepareStatement 可以**防止 SQL 注入攻击**

构造 PrepareStatement 的时候就已经提交了查询 SQL，并被数据库预先生成好了执行计划，后面黑客不管提交什么样的字符串，都只能交给这个执行计划去执行，不可能再生成一个新的 SQL 了，也就不会被攻击了。

数据库索引有两种
- 一种是聚簇索引，聚簇索引的数据库记录和索引存储在一起
- 另一种数据库索引是非聚簇索引，非聚簇索引在叶子节点记录的就不是数据行记录，而是聚簇索引，也就是主键

通过非聚簇索引找到主键索引，再通过主键索引找到行记录的过程也被称作回表。
